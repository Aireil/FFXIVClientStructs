using InteropGenerator.Tests.Helpers;
using Xunit;
using VerifyIG = InteropGenerator.Tests.Helpers.IncrementalGeneratorVerifier<InteropGenerator.Generator.InteropGenerator>;

namespace InteropGenerator.Tests.Generator;

public class FixedSizeArrayAttributeTests {
    [Fact]
    public async Task GenerateFixedArray() {
        const string code = """
                            using InteropGenerator.Runtime.Generated;

                            [GenerateInterop]
                            public partial struct TestStruct
                            {
                                [FixedSizeArray]
                                internal FixedSizeArray10<int> _tenIntArray;
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  /// <inheritdoc cref="_tenIntArray" />
                                  [UnscopedRef] public Span<int> TenIntArray => _tenIntArray;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetFixedSizeArraySource([10]));
    }

    [Fact]
    public async Task GenerateSameFixedArray() {
        const string code = """
                            using InteropGenerator.Runtime.Generated;

                            [GenerateInterop]
                            public partial struct TestStruct
                            {
                                [FixedSizeArray]
                                internal FixedSizeArray10<int> _tenIntArray;
                                
                                [FixedSizeArray]
                                internal FixedSizeArray10<uint> _tenUIntArray;
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  /// <inheritdoc cref="_tenIntArray" />
                                  [UnscopedRef] public Span<int> TenIntArray => _tenIntArray;
                                  /// <inheritdoc cref="_tenUIntArray" />
                                  [UnscopedRef] public Span<uint> TenUIntArray => _tenUIntArray;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetFixedSizeArraySource([10]));
    }

    [Fact]
    public async Task GenerateDifferentFixedArrays() {
        const string code = """
                            using InteropGenerator.Runtime.Generated;

                            [GenerateInterop]
                            public partial struct TestStruct
                            {
                                [FixedSizeArray]
                                internal FixedSizeArray10<int> _tenIntArray;
                                
                                [FixedSizeArray]
                                internal FixedSizeArray57<uint> _fiftySevenUIntArray;
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  /// <inheritdoc cref="_tenIntArray" />
                                  [UnscopedRef] public Span<int> TenIntArray => _tenIntArray;
                                  /// <inheritdoc cref="_fiftySevenUIntArray" />
                                  [UnscopedRef] public Span<uint> FiftySevenUIntArray => _fiftySevenUIntArray;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetFixedSizeArraySource([10, 57]));
    }
}
