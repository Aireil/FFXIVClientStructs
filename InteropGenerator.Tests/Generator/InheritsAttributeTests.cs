using InteropGenerator.Tests.Helpers;
using Xunit;
using VerifyIG = InteropGenerator.Tests.Helpers.IncrementalGeneratorVerifier<InteropGenerator.Generator.InteropGenerator>;

namespace InteropGenerator.Tests.Generator;

public class InheritsAttributeTests {
    [Fact]
    public async Task BasicFieldInheritance() {
        const string code = """
                            [StructLayout(LayoutKind.Explicit, Size=4)]
                            [GenerateInterop(true)]
                            public partial struct BaseStruct
                            {
                                [FieldOffset(0)] public int Field0;
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=8)]
                            [GenerateInterop]
                            [Inherits<BaseStruct>]
                            public partial struct ChildStruct
                            {
                                [FieldOffset(4)] public int Field4;
                            }
                            """;

        const string childStructInheritanceCode = """
                                                  // <auto-generated/>
                                                  unsafe partial struct ChildStruct
                                                  {
                                                      /// <summary>Inherited parent class accessor for <see cref="BaseStruct">BaseStruct</see></summary>
                                                      [FieldOffset(0)] public BaseStruct BaseStruct;
                                                      /// <inheritdoc cref="BaseStruct.Field0" />
                                                      /// <remarks>Field inherited from parent class <see cref="BaseStruct">BaseStruct</see>.</remarks>
                                                      [FieldOffset(0)] public int Field0;
                                                  }
                                                  """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            SourceGeneration.GetEmptyGenerationSource("BaseStruct"),
            SourceGeneration.GetEmptyGenerationSource("ChildStruct"),
            ("ChildStruct.Inheritance.InteropGenerator.g.cs", childStructInheritanceCode));
    }
    
    [Fact]
    public async Task BasicFieldInheritanceOffset() {
        const string code = """
                            [StructLayout(LayoutKind.Explicit, Size=20)]
                            [GenerateInterop(true)]
                            public partial struct BaseStruct
                            {
                                [FieldOffset(16)] public int Field0;
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=28)]
                            [GenerateInterop]
                            [Inherits<BaseStruct>]
                            public partial struct ChildStruct
                            {
                                [FieldOffset(20)] public int Field4;
                            }
                            """;

        const string childStructInheritanceCode = """
                                                  // <auto-generated/>
                                                  unsafe partial struct ChildStruct
                                                  {
                                                      /// <summary>Inherited parent class accessor for <see cref="BaseStruct">BaseStruct</see></summary>
                                                      [FieldOffset(0)] public BaseStruct BaseStruct;
                                                      /// <inheritdoc cref="BaseStruct.Field0" />
                                                      /// <remarks>Field inherited from parent class <see cref="BaseStruct">BaseStruct</see>.</remarks>
                                                      [FieldOffset(16)] public int Field0;
                                                  }
                                                  """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            SourceGeneration.GetEmptyGenerationSource("BaseStruct"),
            SourceGeneration.GetEmptyGenerationSource("ChildStruct"),
            ("ChildStruct.Inheritance.InteropGenerator.g.cs", childStructInheritanceCode));
    }
    
    [Fact]
    public async Task BasicFieldInheritanceExplicitParentOffset() {
        const string code = """
                            [StructLayout(LayoutKind.Explicit, Size=4)]
                            [GenerateInterop(true)]
                            public partial struct BaseStruct
                            {
                                [FieldOffset(0)] public int Field0;
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=24)]
                            [GenerateInterop]
                            [Inherits<BaseStruct>(parentOffset: 16)]
                            public partial struct ChildStruct
                            {
                                [FieldOffset(20)] public int Field20;
                            }
                            """;

        const string childStructInheritanceCode = """
                                                  // <auto-generated/>
                                                  unsafe partial struct ChildStruct
                                                  {
                                                      /// <summary>Inherited parent class accessor for <see cref="BaseStruct">BaseStruct</see></summary>
                                                      [FieldOffset(16)] public BaseStruct BaseStruct;
                                                      /// <inheritdoc cref="BaseStruct.Field0" />
                                                      /// <remarks>Field inherited from parent class <see cref="BaseStruct">BaseStruct</see>.</remarks>
                                                      [FieldOffset(16)] public int Field0;
                                                  }
                                                  """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            SourceGeneration.GetEmptyGenerationSource("BaseStruct"),
            SourceGeneration.GetEmptyGenerationSource("ChildStruct"),
            ("ChildStruct.Inheritance.InteropGenerator.g.cs", childStructInheritanceCode));
    }
    
    [Fact]
    public async Task ChainedFieldInheritance() {
        const string code = """
                            [StructLayout(LayoutKind.Explicit, Size=4)]
                            [GenerateInterop(true)]
                            public partial struct BaseStruct
                            {
                                [FieldOffset(0)] public int BaseStruct_Field0;
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=8)]
                            [GenerateInterop(true)]
                            [Inherits<BaseStruct>]
                            public partial struct MiddleStruct
                            {
                                [FieldOffset(4)] public int MiddleStruct_Field4;
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=12)]
                            [GenerateInterop]
                            [Inherits<MiddleStruct>]
                            public partial struct ChildStruct
                            {
                                [FieldOffset(8)] public int Field8;
                            }
                            """;

        const string middleStructInheritanceCode = """
                                                   // <auto-generated/>
                                                   unsafe partial struct MiddleStruct
                                                   {
                                                       /// <summary>Inherited parent class accessor for <see cref="BaseStruct">BaseStruct</see></summary>
                                                       [FieldOffset(0)] public BaseStruct BaseStruct;
                                                       /// <inheritdoc cref="BaseStruct.BaseStruct_Field0" />
                                                       /// <remarks>Field inherited from parent class <see cref="BaseStruct">BaseStruct</see>.</remarks>
                                                       [FieldOffset(0)] public int BaseStruct_Field0;
                                                   }
                                                   """;

        const string childStructInheritanceCode = """
                                                  // <auto-generated/>
                                                  unsafe partial struct ChildStruct
                                                  {
                                                      /// <inheritdoc cref="BaseStruct.BaseStruct_Field0" />
                                                      /// <remarks>Field inherited from parent class <see cref="BaseStruct">BaseStruct</see>.</remarks>
                                                      [FieldOffset(0)] public int BaseStruct_Field0;
                                                      /// <summary>Inherited parent class accessor for <see cref="MiddleStruct">MiddleStruct</see></summary>
                                                      [FieldOffset(0)] public MiddleStruct MiddleStruct;
                                                      /// <inheritdoc cref="MiddleStruct.MiddleStruct_Field4" />
                                                      /// <remarks>Field inherited from parent class <see cref="MiddleStruct">MiddleStruct</see>.</remarks>
                                                      [FieldOffset(4)] public int MiddleStruct_Field4;
                                                  }
                                                  """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            SourceGeneration.GetEmptyGenerationSource("BaseStruct"),
            SourceGeneration.GetEmptyGenerationSource("MiddleStruct"),
            SourceGeneration.GetEmptyGenerationSource("ChildStruct"),
            ("MiddleStruct.Inheritance.InteropGenerator.g.cs", middleStructInheritanceCode),
            ("ChildStruct.Inheritance.InteropGenerator.g.cs", childStructInheritanceCode));
    }
    
    // [Fact]
    // public async Task ComplexInheritance() {
    //     const string code = """
    //                         [StructLayout(LayoutKind.Explicit, Size=4)]
    //                         [GenerateInterop(true)]
    //                         public partial struct BaseStruct
    //                         {
    //                         }
    //                         
    //                         [StructLayout(LayoutKind.Explicit, Size=8)]
    //                         [GenerateInterop(true)]
    //                         [Inherits<BaseStruct>]
    //                         public partial struct BaseAStruct
    //                         {
    //                         }
    //                         
    //                         [StructLayout(LayoutKind.Explicit, Size=4)]
    //                         [GenerateInterop(true)]
    //                         public partial struct BaseBStruct
    //                         {
    //                         }
    //                         
    //                         [StructLayout(LayoutKind.Explicit, Size=16)]
    //                         [GenerateInterop(true)]
    //                         [Inherits<BaseAStruct>]
    //                         [Inherits<BaseBStruct>]
    //                         public partial struct MiddleStruct
    //                         {
    //                         }
    //                         
    //                         [StructLayout(LayoutKind.Explicit, Size=20)]
    //                         [GenerateInterop]
    //                         [Inherits<MiddleStruct>]
    //                         public partial struct TestStruct
    //                         {
    //                         }
    //                         """;
    //     
    //     const string baseStructResult = """
    //                                      // <auto-generated/>
    //                                      unsafe partial struct BaseStruct
    //                                      {
    //                                      }
    //                                      """;
    //     
    //     const string baseAStructResult = """
    //                                     // <auto-generated/>
    //                                     unsafe partial struct BaseAStruct
    //                                     {
    //                                     }
    //                                     """;
    //     
    //     const string baseAStructInheritanceResult = """
    //                                                  // <auto-generated/>
    //                                                  unsafe partial struct BaseAStruct
    //                                                  {
    //                                                      // BaseStruct 0
    //                                                  }
    //                                                  """;
    //     
    //     const string baseBStructResult = """
    //                                     // <auto-generated/>
    //                                     unsafe partial struct BaseBStruct
    //                                     {
    //                                     }
    //                                     """;
    //     
    //     const string middleStructResult = """
    //                                     // <auto-generated/>
    //                                     unsafe partial struct MiddleStruct
    //                                     {
    //                                     }
    //                                     """;
    //
    //     const string middleStructInheritanceResult = """
    //                                       // <auto-generated/>
    //                                       unsafe partial struct MiddleStruct
    //                                       {
    //                                           // BaseStruct 0
    //                                           // BaseAStruct 0
    //                                           // BaseBStruct 8
    //                                       }
    //                                       """;
    //     
    //     const string testStructResult = """
    //                           // <auto-generated/>
    //                           unsafe partial struct TestStruct
    //                           {
    //                           }
    //                           """;
    //
    //     const string testStructInheritanceResult = """
    //                                      // <auto-generated/>
    //                                      unsafe partial struct TestStruct
    //                                      {
    //                                          // BaseStruct 0
    //                                          // BaseAStruct 0
    //                                          // BaseBStruct 8
    //                                          // MiddleStruct 0
    //                                      }
    //                                      """;
    //
    //     await VerifyIG.VerifyGeneratorAsync(
    //         code,
    //         ("BaseStruct.InteropGenerator.g.cs", baseStructResult),
    //         ("BaseAStruct.InteropGenerator.g.cs", baseAStructResult),
    //         ("BaseBStruct.InteropGenerator.g.cs", baseBStructResult),
    //         ("MiddleStruct.InteropGenerator.g.cs", middleStructResult),
    //         ("TestStruct.InteropGenerator.g.cs", testStructResult),
    //         ("BaseAStruct.Inheritance.InteropGenerator.g.cs", baseAStructInheritanceResult),
    //         ("MiddleStruct.Inheritance.InteropGenerator.g.cs", middleStructInheritanceResult),
    //         ("TestStruct.Inheritance.InteropGenerator.g.cs", testStructInheritanceResult));
    // }
}
