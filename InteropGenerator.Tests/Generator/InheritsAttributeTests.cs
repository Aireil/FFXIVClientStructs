using Xunit;
using VerifyIG = InteropGenerator.Tests.Helpers.IncrementalGeneratorVerifier<InteropGenerator.Generator.InteropGenerator>;

namespace InteropGenerator.Tests.Generator;

public class InheritsAttributeTests {
    [Fact]
    public async Task ComplexInheritance() {
        const string code = """
                            [StructLayout(LayoutKind.Explicit, Size=4)]
                            [GenerateInterop(true)]
                            public partial struct BaseStruct
                            {
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=8)]
                            [GenerateInterop(true)]
                            [Inherits<BaseStruct>]
                            public partial struct BaseAStruct
                            {
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=4)]
                            [GenerateInterop(true)]
                            public partial struct BaseBStruct
                            {
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=16)]
                            [GenerateInterop(true)]
                            [Inherits<BaseAStruct>]
                            [Inherits<BaseBStruct>]
                            public partial struct MiddleStruct
                            {
                            }
                            
                            [StructLayout(LayoutKind.Explicit, Size=20)]
                            [GenerateInterop]
                            [Inherits<MiddleStruct>]
                            public partial struct TestStruct
                            {
                            }
                            """;
        
        const string baseStructResult = """
                                         // <auto-generated/>
                                         unsafe partial struct BaseStruct
                                         {
                                         }
                                         """;
        
        const string baseAStructResult = """
                                        // <auto-generated/>
                                        unsafe partial struct BaseAStruct
                                        {
                                        }
                                        """;
        
        const string baseAStructInheritanceResult = """
                                                     // <auto-generated/>
                                                     unsafe partial struct BaseAStruct
                                                     {
                                                         // BaseStruct 0
                                                     }
                                                     """;
        
        const string baseBStructResult = """
                                        // <auto-generated/>
                                        unsafe partial struct BaseBStruct
                                        {
                                        }
                                        """;
        
        const string middleStructResult = """
                                        // <auto-generated/>
                                        unsafe partial struct MiddleStruct
                                        {
                                        }
                                        """;

        const string middleStructInheritanceResult = """
                                          // <auto-generated/>
                                          unsafe partial struct MiddleStruct
                                          {
                                              // BaseStruct 0
                                              // BaseAStruct 0
                                              // BaseBStruct 8
                                          }
                                          """;
        
        const string testStructResult = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                              }
                              """;

        const string testStructInheritanceResult = """
                                         // <auto-generated/>
                                         unsafe partial struct TestStruct
                                         {
                                             // BaseStruct 0
                                             // BaseAStruct 0
                                             // BaseBStruct 8
                                             // MiddleStruct 0
                                         }
                                         """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("BaseStruct.InteropGenerator.g.cs", baseStructResult),
            ("BaseAStruct.InteropGenerator.g.cs", baseAStructResult),
            ("BaseBStruct.InteropGenerator.g.cs", baseBStructResult),
            ("MiddleStruct.InteropGenerator.g.cs", middleStructResult),
            ("TestStruct.InteropGenerator.g.cs", testStructResult),
            ("BaseAStruct.Inheritance.InteropGenerator.g.cs", baseAStructInheritanceResult),
            ("MiddleStruct.Inheritance.InteropGenerator.g.cs", middleStructInheritanceResult),
            ("TestStruct.Inheritance.InteropGenerator.g.cs", testStructInheritanceResult));
    }
}
