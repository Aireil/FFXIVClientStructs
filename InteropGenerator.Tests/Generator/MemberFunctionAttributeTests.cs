using Xunit;
using VerifyIG = InteropGenerator.Tests.Helpers.IncrementalGeneratorVerifier<InteropGenerator.Generator.InteropGenerator>;

namespace InteropGenerator.Tests.Generator;

public class MemberFunctionAttributeTests {
    [Fact]
    public async Task GenerateMemberFunction() {
        const string code = """
                            [GenerateInterop]
                            public unsafe partial struct TestStruct
                            {
                                [MemberFunction("AA BB CC DD ?? ?? ?? ?? AA BB ?? DD")]
                                public partial int TestFunction(int argOne, void * argTwo);
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  public static class Addresses
                                  {
                                      public static readonly Address TestFunction = new Address("TestStruct.TestFunction", "AA BB CC DD ?? ?? ?? ?? AA BB ?? DD ?? ?? ?? ??", new ulong[] {0x00000000DDCCBBAA, 0x00000000DD00BBAA}, new ulong[] {0x00000000FFFFFFFF, 0x00000000FF00FFFF}, 0);
                                  }
                                  public unsafe static class MemberFunctionPointers
                                  {
                                      public static delegate* unmanaged[Stdcall] <TestStruct*, int, void*, int> TestFunction => (delegate* unmanaged[Stdcall] <TestStruct*, int, void*, int>) TestStruct.Addresses.TestFunction.Value;
                                  }
                                  public partial int TestFunction(int argOne, void* argTwo)
                                  {
                                      if (MemberFunctionPointers.TestFunction is null)
                                      {
                                          throw new InvalidOperationException("Function pointer for TestStruct.TestFunction is null. The resolver was either uninitialized or failed to resolve address with signature AA BB CC DD ?? ?? ?? ?? AA BB ?? DD.");
                                      }
                                      return MemberFunctionPointers.TestFunction((TestStruct*)Unsafe.AsPointer(ref this), argOne, argTwo);
                                  }
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result));
    }
    
}
